<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garn Tracker — Eingabe</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:24px auto;padding:0 16px;color:#111}
    form{display:grid;gap:8px;background:#f8f8f8;padding:12px;border-radius:8px;border:1px solid #e0e0e0}
    label{display:flex;flex-direction:column;font-size:14px}
    fieldset{border:1px solid #ddd;padding:8px;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:13px}
    .actions{display:flex;gap:8px;align-items:center}
    button{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
    button.primary{background:#0b74de;color:#fff;border-color:#0b74de}
    .small{font-size:12px;padding:6px 8px}
  </style>
</head>
<body>
  <h1>Garn hinzufügen</h1>

  <form id="yarn-form">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <label>Marke
        <select name="brand" required>
          <option value="">— wählen —</option>
          <option>Drops</option>
          <option>Schachenmayr</option>
          <option>Hobbii</option>
        </select>
      </label>

      <label>Name / Artikel
        <input type="text" name="name" placeholder="z. B. Merino Extra Fine" required>
      </label>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <label>Material
        <input type="text" name="material" placeholder="z. B. Merino, Baumwolle" required>
      </label>

      <label>Projektidee
        <input list="projects" name="project_idea" placeholder="z. B. Pullover">
        <datalist id="projects">
          <option>Schal</option><option>Pullover</option><option>Mütze</option>
        </datalist>
      </label>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
      <label>Lauflänge (m / Knäuel)
        <input type="number" name="length_m" min="0" step="0.1" value="100" required>
      </label>

      <label>Gewicht (g / Knäuel)
        <select name="grams_per_skein" required>
          <option value="">— wählen —</option>
          <option value="25">25g</option>
          <option value="50">50g</option>
          <option value="100">100g</option>
        </select>
      </label>

      <label>Farbe
        <select name="color" required>
          <option value="">— wählen —</option>
          <option>rot</option><option>blau</option><option>gelb</option><option>weiß</option>
        </select>
      </label>
    </div>

    <fieldset>
      <legend>Vorhandene Menge</legend>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="flex:1">Anzahl / Menge
          <input type="number" name="quantity" min="0" step="1" placeholder="z. B. 5" required>
        </label>

        <label>Einheit
          <select name="quantity_unit">
            <option value="skeins">Knäuel</option>
            <option value="grams">g</option>
          </select>
        </label>

        <div style="font-size:12px;color:#555">Das System rechnet Knäuel ↔ g mit dem gewählten Gramm‑Wert.</div>
      </div>
    </fieldset>

    <div class="actions">
      <button type="submit" class="primary">➕ Garn hinzufügen</button>
      <button type="button" id="clear-storage" class="small">Alles löschen</button>
      <button type="button" id="export-csv" class="small">CSV export</button>
      <div style="margin-left:auto;font-size:13px;color:#666">Speicherung: localStorage</div>
    </div>
  </form>

  <h2>Übersicht</h2>
  <input type="search" id="filter" placeholder="Filtern nach Marke, Material, Farbe, Projekt..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px">

  <table id="yarn-table">
    <thead>
      <tr>
        <th>Marke</th><th>Name</th><th>Material</th><th>Lauflänge (m)</th><th>g/Knäuel</th><th>Farbe</th><th>Projekt</th><th>Menge</th><th>Einheit</th><th>Verfügbar (m)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const form = document.getElementById('yarn-form');
    const tbody = document.querySelector('#yarn-table tbody');
    const STORAGE_KEY = 'yarn_stash_v1';

    function loadEntries(){
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }

    function saveEntries(list){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function skeinsFromQuantity(q, unit, gramsPerSkein){
      if(unit === 'skeins') return q;
      if(!gramsPerSkein) return 0;
      return q / gramsPerSkein;
    }

    function renderTable(filterText = ''){
      const rows = loadEntries();
      tbody.innerHTML = '';
      const ft = filterText.trim().toLowerCase();
      rows.forEach(r=>{
        const searchable = [r.brand,r.name,r.material,r.color,r.project_idea].join(' ').toLowerCase();
        if(ft && !searchable.includes(ft)) return;
        const skeins = skeinsFromQuantity(r.quantity, r.quantity_unit, Number(r.grams_per_skein));
        const availableMeters = (skeins * Number(r.length_m)) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.brand}</td>
                        <td>${r.name}</td>
                        <td>${r.material}</td>
                        <td>${r.length_m}</td>
                        <td>${r.grams_per_skein}g</td>
                        <td>${r.color}</td>
                        <td>${r.project_idea || ''}</td>
                        <td>${r.quantity}</td>
                        <td>${r.quantity_unit}</td>
                        <td>${availableMeters.toFixed(1)}</td>`;
        tbody.appendChild(tr);
      });
    }

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const fd = new FormData(form);
      const entry = {
        brand: fd.get('brand') || '',
        name: fd.get('name') || '',
        material: fd.get('material') || '',
        length_m: fd.get('length_m') || 0,
        grams_per_skein: fd.get('grams_per_skein') || '',
        color: fd.get('color') || '',
        project_idea: fd.get('project_idea') || '',
        quantity: Number(fd.get('quantity') || 0),
        quantity_unit: fd.get('quantity_unit') || 'skeins',
        created_at: new Date().toISOString()
      };
      const list = loadEntries();
      list.unshift(entry);
      saveEntries(list);
      renderTable(document.getElementById('filter').value);
      form.reset();
    });

    document.getElementById('clear-storage').addEventListener('click', ()=>{
      if(confirm('Alle Einträge löschen?')){ localStorage.removeItem(STORAGE_KEY); renderTable(); }
    });

    document.getElementById('export-csv').addEventListener('click', ()=>{
      const rows = loadEntries();
      if(!rows.length){ alert('Keine Einträge.'); return; }
      const header = ['brand','name','material','length_m','grams_per_skein','color','project_idea','quantity','quantity_unit','created_at'];
      const csv = [header.join(',')].concat(rows.map(r=>header.map(h=>`"${String(r[h]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'garn_stash.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('filter').addEventListener('input', e=>renderTable(e.target.value));

    // initial render
    renderTable();
  </script>
</body>
</html>